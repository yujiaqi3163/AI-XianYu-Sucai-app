# Flask Web 应用开发文档

## 项目概述
本项目是一个基于 Flask + Tailwind CSS 的 Web 应用，包含用户认证、素材管理、管理后台等功能，采用移动端适配设计。

---

## 一、项目结构

```
my_flask_app/
├── app/                          # 应用主目录
│   ├── __init__.py              # 应用配置入口
│   ├── templates/                # HTML 模板目录
│   │   ├── base.html           # 前台基础模板
│   │   ├── main/               # 前台页面模板目录
│   │   │   ├── index.html      # 首页模板
│   │   │   ├── profile.html    # 个人中心模板
│   │   │   ├── profile_edit.html # 个人资料编辑模板
│   │   │   └── material_detail.html # 素材详情模板
│   │   ├── auth/               # 认证相关模板目录
│   │   │   ├── login.html      # 登录页面模板
│   │   │   └── register.html   # 注册页面模板
│   │   └── admin/              # 管理后台模板目录
│   │       ├── admin_base.html # 管理后台基础模板
│   │       ├── admin_index.html# 管理后台首页
│   │       ├── admin_materials.html    # 素材库管理
│   │       ├── admin_material_add.html  # 添加素材
│   │       ├── admin_material_types.html # 分类管理
│   │       ├── admin_secrets.html # 卡密管理
│   │       └── admin_users.html # 用户管理
│   ├── static/                   # 静态资源目录
│   │   ├── css/
│   │   │   └── output.css      # Tailwind 编译后的 CSS
│   │   ├── src/
│   │   │   └── input.css       # Tailwind 源文件
│   │   └── uploads/             # 图片上传目录
│   ├── models/                   # 数据模型目录
│   │   ├── __init__.py
│   │   ├── user.py              # User 用户模型
│   │   ├── register_secret.py   # 注册卡密模型
│   │   ├── material_type.py     # 素材类型模型
│   │   ├── material.py          # 素材模型
│   │   └── material_image.py    # 素材图片模型
│   ├── routes/                   # 路由目录
│   │   ├── __init__.py
│   │   ├── main/
│   │   │   ├── __init__.py
│   │   │   └── routes.py        # 主路由 Blueprint
│   │   ├── auth/
│   │   │   ├── __init__.py
│   │   │   └── routes.py        # 认证路由
│   │   └── admin/
│   │       ├── __init__.py
│   │       └── routes.py        # 管理后台路由
│   └── forms/                    # 表单验证目录
│       ├── __init__.py
│       ├── auth.py              # 认证表单
│       ├── admin.py             # 管理后台表单
│       └── material_type.py     # 分类管理表单
├── run.py                        # 应用启动文件
├── package.json                  # npm 配置文件
├── tailwind.config.js            # Tailwind CSS 配置
├── app.db                        # SQLite 数据库文件
├── scripts/                      # 脚本和工具目录
│   ├── migrate_secrets_table.py  # 卡密表迁移脚本
│   ├── migrate_user_table.py     # 用户表迁移脚本
│   └── update_material_stats.py  # 素材统计更新脚本（临时测试）
├── 代码大全.txt                  # 命令记录
├── 素材库功能开发记录.md        # 素材库开发记录
└── 项目开发记录.md               # 本文件
```

---

## 二、功能实现逻辑详解

### 1. 用户登录注册功能

#### 1.1 数据模型 (app/models/user.py)
```python
class User(db.Model):
    id: Integer (主键)
    username: String(80) (唯一, 索引)
    email: String(120) (唯一, 索引)
    password_hash: String(256) (密码哈希)
    is_admin: Boolean (是否管理员, 默认False)
    is_super_admin: Boolean (是否超级管理员, 默认False)
    created_at: DateTime (创建时间)
    
    方法:
    - set_password(password): 使用 werkzeug.security 加密密码
    - check_password(password): 验证密码
```

#### 1.2 注册卡密模型 (app/models/register_secret.py)
```python
class RegisterSecret(db.Model):
    id: Integer (主键)
    secret: String(64) (卡密, 唯一, 索引)
    is_used: Boolean (是否已使用, 默认False)
    user_id: Integer (外键, 关联User)
    created_at: DateTime (创建时间)
    used_at: DateTime (使用时间, 可为空)
```

#### 1.3 登录表单 (app/forms/auth.py)
```python
class LoginForm(FlaskForm):
    username_or_email: StringField (用户名或邮箱)
    password: PasswordField (密码)
    remember: BooleanField (记住我)
```

#### 1.4 注册表单 (app/forms/auth.py)
```python
class RegisterForm(FlaskForm):
    username: StringField (用户名, 3-20字符)
    email: EmailField (邮箱)
    password: PasswordField (密码, 至少6字符)
    confirm_password: PasswordField (确认密码)
    secret: StringField (注册卡密)
```

#### 1.5 登录实现逻辑 (app/routes/auth/routes.py:11-32)
**流程图：**
```
GET /auth/login
    ↓
检查是否已登录 → 已登录 → 重定向首页
    ↓ 未登录
渲染登录页面 (login.html)
    ↓
POST /auth/login
    ↓
表单验证 (validate_on_submit)
    ↓
查询用户 (按用户名或邮箱)
    ↓
验证密码 (check_password)
    ↓
登录用户 (login_user)
    ↓
显示成功消息 (flash)
    ↓
重定向到首页或 next 页面
```

#### 1.6 注册实现逻辑 (app/routes/auth/routes.py:35-63)
**流程图：**
```
GET /auth/register
    ↓
检查是否已登录 → 已登录 → 重定向首页
    ↓ 未登录
渲染注册页面 (register.html)
    ↓
POST /auth/register
    ↓
表单验证 (validate_on_submit)
    ↓
验证注册卡密 (查询RegisterSecret)
    ↓
创建用户 (User)
    ↓
标记卡密已使用 (is_used=True)
    ↓
提交数据库 (db.session.commit)
    ↓
显示成功消息 (flash)
    ↓
重定向到登录页
```

#### 1.7 登出实现 (app/routes/auth/routes.py:66-70)
```
GET /auth/logout
    ↓
logout_user() (Flask-Login 登出)
    ↓
显示消息
    ↓
重定向到登录页
```

---

### 2. 素材分类管理功能

#### 2.1 数据模型 (app/models/material_type.py)
```python
class MaterialType(db.Model):
    id: Integer (主键)
    name: String(50) (分类名称, 唯一, 索引)
    description: String(200) (分类描述, 可为空)
    sort_order: Integer (排序, 兼容旧数据库, 默认0)
    is_active: Boolean (是否启用, 兼容旧数据库, 默认True)
    created_at: DateTime (创建时间)
    
    关系:
    - materials: 与素材的一对多关系
```

#### 2.2 分类管理页面 (app/templates/admin/admin_material_types.html)
**特性：**
- 单页面操作（无需跳转）
- 弹窗形式添加/编辑分类
- AJAX异步请求API
- 分类列表从数据库真实数据渲染

#### 2.3 API路由实现 (app/routes/admin/routes.py)

**添加分类 API (POST /admin/api/material-types):**
```python
逻辑流程:
1. 接收JSON数据
2. 验证分类名称非空
3. 检查分类名称是否已存在
4. 创建MaterialType对象
5. 提交数据库
6. 返回JSON响应
```

**获取单个分类 API (GET /admin/api/material-types/<id>):**
```python
逻辑流程:
1. 根据ID查询分类
2. 返回分类数据JSON
```

**更新分类 API (PUT /admin/api/material-types/<id>):**
```python
逻辑流程:
1. 根据ID查询分类
2. 验证新名称非空
3. 检查新名称是否已存在（排除当前分类）
4. 更新分类信息
5. 提交数据库
6. 返回JSON响应
```

**删除分类 API (DELETE /admin/api/material-types/<id>):**
```python
逻辑流程:
1. 根据ID查询分类
2. 将关联素材的material_type_id设为NULL
3. 删除分类
4. 提交数据库
5. 返回JSON响应
```

#### 2.4 前端JavaScript逻辑 (admin_material_types.html:104-219)
```javascript
功能函数:
- openModal(id): 打开添加/编辑弹窗
- closeModal(): 关闭弹窗
- showToast(message, isError): 显示提示消息
- saveMaterialType(): 保存分类（调用API）
- deleteMaterialType(id): 删除分类（调用API）
```

---

### 3. 素材添加功能

#### 3.1 数据模型

**素材主表 (app/models/material.py):**
```python
class Material(db.Model):
    id: Integer (主键)
    title: String(200) (标题, 索引, 非空)
    description: Text (文案, 非空)
    material_type_id: Integer (分类ID, 外键, 可为空)
    view_count: Integer (浏览次数, 默认0)
    is_published: Boolean (是否上架, 默认True)
    created_at: DateTime (创建时间)
    updated_at: DateTime (最后修改时间)
    
    关系:
    - material_type: 关联到分类
    - images: 与素材图片的一对多关系
```

**素材图片表 (app/models/material_image.py):**
```python
class MaterialImage(db.Model):
    id: Integer (主键)
    material_id: Integer (素材ID, 外键, 非空)
    image_url: String(255) (图片路径, 非空)
    sort_order: Integer (排序, 默认0)
    is_cover: Boolean (是否封面, 默认False)
    created_at: DateTime (创建时间)
    
    关系:
    - material: 关联到素材
```

#### 3.2 素材表单 (app/forms/admin.py)
```python
class MaterialForm(FlaskForm):
    title: StringField (标题, 必填)
    description: TextAreaField (文案, 必填)
    material_type_id: SelectField (分类选择)
    is_published: BooleanField (是否上架)
```

#### 3.3 图片保存函数 (app/routes/admin/routes.py:21-42)
```python
def save_image(file):
    逻辑:
    1. 生成安全文件名 (secure_filename)
    2. 添加时间戳避免重名
    3. 创建上传目录 (static/uploads)
    4. 保存文件
    5. 返回相对路径 (/static/uploads/xxx.jpg)
```

#### 3.4 素材添加实现逻辑 (app/routes/admin/routes.py:59-135)
**流程图：**
```
GET /admin/materials/add
    ↓
创建表单实例
    ↓
查询所有分类，填充选择框
    ↓
渲染添加素材页面 (admin_material_add.html)
    ↓
POST /admin/materials/add
    ↓
表单验证 (validate_on_submit)
    ↓
保存封面图 (save_image)
    ↓
保存其他图片 (save_image, 最多8张)
    ↓
检查封面图是否上传 → 未上传 → 提示错误
    ↓ 已上传
创建Material对象
    ↓
保存到数据库 (db.session.add + flush)
    ↓
保存封面图到MaterialImage (is_cover=True)
    ↓
保存其他图片到MaterialImage (is_cover=False)
    ↓
提交数据库 (db.session.commit)
    ↓
显示成功消息
    ↓
重定向到素材列表页
```

#### 3.5 前端图片预览功能 (admin_material_add.html)
```javascript
特性:
- 封面图选择后立即预览
- 其他图片支持多张预览
- 支持删除已选图片
- 最多支持8张其他图片
```

---

## 三、应用配置 (app/__init__.py)

### 配置类
```python
class Config:
    SECRET_KEY: 会话密钥
    SQLALCHEMY_DATABASE_URI: 数据库连接地址 (SQLite)
    SQLALCHEMY_TRACK_MODIFICATIONS: False (关闭修改跟踪)
    WTF_CSRF_ENABLED: False (临时禁用CSRF，方便开发)
```

### 应用工厂
```python
create_app():
    1. 创建Flask应用实例
    2. 初始化数据库 (db.init_app)
    3. 初始化LoginManager (用户认证)
    4. 注册Blueprint路由
        - main_bp (主路由)
        - auth_bp (认证路由, /auth前缀)
        - admin_bp (管理后台路由, /admin前缀)
    5. 返回应用实例
```

---

## 四、使用说明

### 运行应用
```powershell
.\venv\Scripts\activate
python run.py
```
访问 `http://localhost:5000`

### 页面地址
- **首页**: `http://localhost:5000`
- **登录**: `http://localhost:5000/auth/login`
- **注册**: `http://localhost:5000/auth/register`
- **个人中心**: `http://localhost:5000/profile`
- **管理后台**: `http://localhost:5000/admin/`
- **分类管理**: `http://localhost:5000/admin/material-types`
- **素材库**: `http://localhost:5000/admin/materials`
- **添加素材**: `http://localhost:5000/admin/materials/add`

---

## 五、技术栈
- **后端框架**: Flask 3.1.3
- **数据库**: SQLite + Flask-SQLAlchemy 3.1.1
- **前端样式**: Tailwind CSS 3.4.0
- **表单验证**: Flask-WTF 1.2.2
- **用户认证**: Flask-Login 0.6.3
- **架构模式**: 工厂模式 + Blueprint
- **设计风格**: 移动端适配

---

### 4. 素材库管理功能

#### 4.1 素材列表渲染 (app/templates/admin/admin_materials.html)
**特性：**
- 从数据库获取真实素材数据渲染
- 单素材卡片显示：封面图、标题、分类、热度、收藏数、下载数、文案缩略
- 封面图完整占满左侧区域，四个角圆角
- 右侧显示素材信息和操作按钮（编辑、删除）

#### 4.2 素材删除功能 (app/routes/admin/routes.py)
**实现逻辑：**
```python
1. 根据ID查询素材
2. 关联删除素材图片记录
3. 删除文件系统中的图片文件
4. 删除素材记录
5. 提交数据库
6. 显示成功消息
7. 重定向素材列表
```

#### 4.3 素材编辑功能 (app/routes/admin/routes.py)
**特性：**
- 与添加素材共享同一个页面模板
- 条件渲染区分添加/编辑模式
- 编辑模式下：
  - 封面图渲染当前封面
  - 细节图渲染所有非封面图片
  - 支持勾选删除现有细节图
  - 支持新增细节图实时预览

#### 4.4 无限滚动加载 (app/templates/admin/admin_materials.html)
**实现逻辑：**
```javascript
1. 监听滚动事件
2. 检查是否滚动到底部
3. 如果有更多数据，调用API获取下一页
4. 追加渲染新数据到列表
5. 更新是否有更多数据标志
```

#### 4.5 分类筛选功能 (app/templates/admin/admin_materials.html)
**特性：**
- 点击分类按钮，列表筛选该分类素材
- 分类按钮高亮显示当前选中状态
- 支持"全部"选项显示所有素材

#### 4.6 搜索功能 (app/routes/admin/routes.py)
**实现逻辑：**
```python
1. 获取搜索关键词
2. 使用 contains() 模糊匹配标题
3. 支持与分类筛选组合使用
4. 返回匹配的素材列表
```

---

### 5. 首页轮播图与素材展示

#### 5.1 轮播图渲染 (app/templates/main/index.html)
**特性：**
- 从数据库按浏览量排序，取前5个素材
- 显示：分类标签、标题、浏览/收藏/下载数、封面图
- 自动轮播播放

#### 5.2 最新入库素材 (app/templates/main/index.html)
**特性：**
- 无限滚动加载更多素材
- 图片左上角显示分类标签
- 支持排序：最新、浏览、收藏、下载
- 搜索功能（匹配标题）

#### 5.3 顶部导航栏优化 (app/templates/base.html)
**修改：**
- 左边：用户头像 + 用户名称
- 中间：AI素材网标题
- 右边：消息中心（不变）
- 头像支持显示用户上传的头像

---

### 6. 个人资料编辑功能

#### 6.1 User模型扩展 (app/models/user.py:30-37)
```python
新增字段：
- avatar: String(500) (头像URL, 可空)
- bio: String(200) (个性签名, 可空)
- gender: String(10) (性别: male/female/other, 可空)
- birthday: Date (出生日期, 可空)
```

#### 6.2 数据库迁移 (migrate_user_table.py)
**功能：**
- 检查列是否存在
- ALTER TABLE 添加新列
- 支持SQLite数据库

#### 6.3 编辑页面 (app/templates/main/profile_edit.html)
**表单字段：**
1. 头像上传与预览
2. 用户昵称（可编辑）
3. 绑定邮箱（只读，不可修改）
4. 性别选择（单选：男/女/其他）
5. 出生日期（日期选择器）
6. 个性签名（文本域）

**UI优化：**
- 性别选择：选中时边框+背景色变化（男-蓝色，女-粉色，其他-灰色）
- 日期选择器：美化倒三角按钮，防止溢出
- 退出账号按钮：链接到 /auth/logout

#### 6.4 后端处理逻辑 (app/routes/main/routes.py:60-103)
**实现流程：**
```python
1. 获取表单数据
2. 处理出生日期字符串 → Date类型
3. 检查用户名是否重复
4. 更新用户信息
5. 处理头像上传
6. 保存到数据库
7. 显示成功消息
8. 重定向个人中心
```

#### 6.5 个人中心显示 (app/templates/main/profile.html)
**显示内容：**
- 用户头像（上传的头像或默认图标）
- 用户名 + 性别符号（♂蓝色/♀粉色）
- 邮箱（不显示出生日期）
- 个性签名（一行截断）
- 用户角色标签
- 隐藏顶部导航栏（不显示base的header）

---

## 六、已完成功能清单
- ✅ 用户注册（卡密验证）
- ✅ 用户登录（支持用户名/邮箱）
- ✅ 用户退出登录
- ✅ 个人中心页面（显示用户信息、角色标签）
- ✅ 消息闪现与自动消失（5秒）
- ✅ 管理后台框架
- ✅ 素材分类管理（AJAX增删改查）
- ✅ 素材添加功能（标题、文案、分类）
- ✅ 图片上传（封面图必填、其他图片可选最多8张）
- ✅ 图片预览与删除
- ✅ 分类删除（自动将关联素材设为未分类）
- ✅ 弹窗式操作（无需页面跳转）
- ✅ 素材列表渲染（真实数据）
- ✅ 素材删除功能
- ✅ 素材编辑功能
- ✅ 无限滚动加载
- ✅ 分类筛选功能
- ✅ 搜索功能（标题模糊匹配）
- ✅ 首页轮播图（真实数据，热度排行）
- ✅ 最新入库素材（无限滚动、排序、搜索）
- ✅ 个人资料编辑（头像、昵称、邮箱、性别、生日、签名）
- ✅ 邮箱只读保护
- ✅ 退出账号功能绑定
- ✅ 个人中心页面优化（隐藏顶部导航）

---

### 7. 卡密管理功能

#### 7.1 RegisterSecret模型扩展 (app/models/register_secret.py)
```python
新增字段：
- duration_type: String(20) (卡密类型: day/month/year/permanent/test)
- expires_at: DateTime (过期时间，用户使用后计算)
```

#### 7.2 卡密生成功能 (app/routes/admin/routes.py)
**特性：**
- 选择卡密时长：日卡1天、月卡1个月、年卡1年、永久卡、1分钟测试卡
- 支持批量生成（可选择数量）
- 卡密格式：sk- + 18位随机数字+英文大小写
- 过期时间从用户使用时开始计算，而非生成时

#### 7.3 卡密列表渲染 (app/templates/admin/admin_secrets.html)
**特性：**
- 从数据库获取真实卡密数据渲染
- 支持状态筛选：全部、未使用、已使用、已失效
- 支持搜索：卡密文本或用户昵称
- 已核销卡密显示到期时间和状态（使用中/已失效）
- 复制卡密功能（兼容HTTP和HTTPS）

#### 7.4 旧卡密释放逻辑 (app/routes/main/routes.py)
**实现：**
- 用户续费时，将过期的旧卡密与用户解除关联
- 管理员可以一键删除已释放的卡密
- 在未到期的已使用卡密中添加手动释放功能

#### 7.5 个人中心卡密展示 (app/templates/main/profile.html)
**特性：**
- 显示卡密有效期（永久/至xxxx-xx-xx）
- 过期卡密显示"已失效，请联系管理购买"
- 永久会员高亮显示
- 点击卡密信息显示详情弹窗
- 详情弹窗包含：卡密文本、类型、使用时间、到期时间（精确到分钟）
- 过期卡密在详情弹窗显示续费表单

---

### 8. 用户管理功能

#### 8.1 用户列表渲染 (app/templates/admin/admin_users.html)
**特性：**
- 从数据库获取真实用户数据渲染
- 支持搜索：邮箱或用户名
- 显示用户信息：头像、用户名、邮箱、角色标签、注册时间

#### 8.2 用户管理操作 (app/routes/admin/routes.py)
**功能：**
- 设置管理员
- 取消管理员
- 删除用户（只有普通用户可以删除，带危险提示）
- 删除用户时级联删除关联的卡密数据

---

### 9. 管理后台数据统计

#### 9.1 数据实时渲染 (app/templates/admin/admin_index.html)
**内容：**
- 总素材数
- 未使用卡密数
- 用户总数
- 最新素材（前3个，最新创建）
- 最新卡密（前3个，最新创建）

---

### 10. 素材详情页功能

#### 10.1 路由配置 (app/routes/main/routes.py)
```python
@bp.route('/material/<int:material_id>')
@login_required
def material_detail(material_id):
    """素材详情页面"""
    material = Material.query.get_or_404(material_id)
    material.view_count += 1  # 增加浏览量
    db.session.commit()
    return render_template('main/material_detail.html', material=material)
```

#### 10.2 轮播图展示 (app/templates/main/material_detail.html)
**特性：**
- 1:1比例图片展示
- 展示当前素材的所有图片
- 支持触摸滑动、自动播放
- 双向无感循环（左右无限滑动）
- 轮播图指示器

#### 10.3 详情页布局优化
**内容：**
- 顶部导航：返回按钮 + 素材详情标题 + 收藏按钮
- 轮播图区域
- 信息卡片：标题（蓝色高亮）、文案（灰色，3行截断）、分类（渐变背景）
- 下载按钮：普通下载 + 高级AI下载
- 隐藏底部导航栏
- 隐藏base.html的顶部导航栏，使用自定义导航

---

## 六、已完成功能清单（更新）
- ✅ 用户注册（卡密验证）
- ✅ 用户登录（支持用户名/邮箱）
- ✅ 用户退出登录
- ✅ 个人中心页面（显示用户信息、角色标签）
- ✅ 消息闪现与自动消失（5秒）
- ✅ 管理后台框架
- ✅ 素材分类管理（AJAX增删改查）
- ✅ 素材添加功能（标题、文案、分类）
- ✅ 图片上传（封面图必填、其他图片可选最多8张）
- ✅ 图片预览与删除
- ✅ 分类删除（自动将关联素材设为未分类）
- ✅ 弹窗式操作（无需页面跳转）
- ✅ 素材列表渲染（真实数据）
- ✅ 素材删除功能
- ✅ 素材编辑功能
- ✅ 无限滚动加载
- ✅ 分类筛选功能
- ✅ 搜索功能（标题模糊匹配）
- ✅ 首页轮播图（真实数据，热度排行）
- ✅ 最新入库素材（无限滚动、排序、搜索）
- ✅ 个人资料编辑（头像、昵称、邮箱、性别、生日、签名）
- ✅ 邮箱只读保护
- ✅ 退出账号功能绑定
- ✅ 个人中心页面优化（隐藏顶部导航）
- ✅ 卡密管理功能（生成、列表、搜索、释放、删除）
- ✅ 用户管理功能（列表、搜索、设置/取消管理员、删除）
- ✅ 管理后台数据统计实时渲染
- ✅ 素材详情页（轮播图、信息展示、下载按钮）
