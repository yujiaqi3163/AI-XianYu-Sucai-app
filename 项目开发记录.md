# AI素材库项目开发文档

## 项目概述

本项目是一个基于 Flask + Tailwind CSS 的移动端 AI 素材库 Web 应用，包含用户认证、素材管理、卡密管理、用户管理等功能。

---

## 一、技术栈

- **后端框架**：Flask 3.1.3
- **数据库**：SQLite + Flask-SQLAlchemy 3.1.1
- **前端样式**：Tailwind CSS 3.4.0
- **表单验证**：Flask-WTF 1.2.2
- **用户认证**：Flask-Login 0.6.3
- **架构模式**：工厂模式 + Blueprint
- **设计风格**：移动端适配

---

## 二、项目结构

```
my_flask_app/
├── app/                          # 应用主目录
│   ├── __init__.py              # 应用配置入口（工厂模式）
│   ├── templates/                # HTML 模板目录
│   │   ├── base.html           # 前台基础模板
│   │   ├── main/               # 前台页面模板
│   │   │   ├── index.html      # 首页（轮播图 + 素材列表）
│   │   │   ├── profile.html    # 个人中心
│   │   │   ├── profile_edit.html # 个人资料编辑
│   │   │   └── material_detail.html # 素材详情页
│   │   ├── auth/               # 认证相关模板
│   │   │   ├── login.html      # 登录页面
│   │   │   └── register.html   # 注册页面
│   │   └── admin/              # 管理后台模板
│   │       ├── admin_base.html # 管理后台基础模板
│   │       ├── admin_index.html# 管理后台首页（数据统计）
│   │       ├── admin_materials.html    # 素材库管理
│   │       ├── admin_material_add.html  # 添加/编辑素材
│   │       ├── admin_material_types.html # 分类管理
│   │       ├── admin_secrets.html # 卡密管理
│   │       └── admin_users.html # 用户管理
│   ├── static/                   # 静态资源目录
│   │   ├── css/
│   │   │   └── output.css      # Tailwind 编译后的 CSS
│   │   ├── src/
│   │   │   └── input.css       # Tailwind 源文件
│   │   └── uploads/             # 图片上传目录
│   ├── models/                   # 数据模型目录
│   │   ├── __init__.py
│   │   ├── user.py              # User 用户模型
│   │   ├── material_type.py     # 素材类型模型
│   │   ├── material.py          # 素材模型
│   │   ├── material_image.py    # 素材图片模型
│   │   └── register_secret.py   # 注册卡密模型
│   ├── routes/                   # 路由目录
│   │   ├── __init__.py
│   │   ├── main/
│   │   │   ├── __init__.py
│   │   │   └── routes.py        # 主路由 Blueprint
│   │   ├── auth/
│   │   │   ├── __init__.py
│   │   │   └── routes.py        # 认证路由
│   │   └── admin/
│   │       ├── __init__.py
│   │       └── routes.py        # 管理后台路由
│   └── forms/                    # 表单验证目录
│       ├── __init__.py
│       ├── auth.py              # 认证表单
│       ├── admin.py             # 管理后台表单
│       └── material_type.py     # 分类管理表单
├── scripts/                      # 脚本和工具目录
│   ├── migrate_secrets_table.py  # 卡密表迁移脚本
│   ├── migrate_user_table.py     # 用户表迁移脚本
│   └── update_material_stats.py  # 素材统计更新脚本（临时测试）
├── run.py                        # 应用启动文件
├── package.json                  # npm 配置文件
├── tailwind.config.js            # Tailwind CSS 配置
├── app.db                        # SQLite 数据库文件
├── 代码大全.txt                  # 命令记录
├── 素材库功能开发记录.md        # 素材库开发记录
└── 项目开发记录.md               # 本文件
```

---

## 三、数据模型详解

### 3.1 User（用户模型）

**文件位置**：`app/models/user.py`

**字段说明**：
```python
- id: Integer (主键)
- username: String(80) (用户名，唯一，索引)
- email: String(120) (邮箱，唯一，索引)
- password_hash: String(256) (密码哈希，使用 werkzeug.security 加密)
- is_admin: Boolean (是否管理员，默认False)
- is_super_admin: Boolean (是否超级管理员，默认False)
- avatar: String(500) (头像URL，可空)
- bio: String(200) (个性签名，可空)
- gender: String(10) (性别：male/female/other，可空)
- birthday: Date (出生日期，可空)
- created_at: DateTime (创建时间)

- 关系：
  - register_secrets: 与卡密的一对多关系，级联删除
```

**方法**：
- `set_password(password)`: 设置密码，自动加密
- `check_password(password)`: 验证密码

---

### 3.2 MaterialType（素材类型/分类模型）

**文件位置**：`app/models/material_type.py`

**字段说明**：
```python
- id: Integer (主键)
- name: String(50) (分类名称，唯一，索引)
- description: String(200) (分类描述，可空)
- sort_order: Integer (排序，默认0)
- is_active: Boolean (是否启用，默认True)
- created_at: DateTime (创建时间)

- 关系：
  - materials: 与素材的一对多关系
```

---

### 3.3 Material（素材模型）

**文件位置**：`app/models/material.py`

**字段说明**：
```python
- id: Integer (主键)
- title: String(200) (标题，索引，非空)
- description: Text (文案，可空)
- material_type_id: Integer (分类ID，外键，可空)
- view_count: Integer (浏览次数，默认0)
- favorite_count: Integer (收藏次数，默认0)
- download_count: Integer (下载次数，默认0)
- is_published: Boolean (是否上架，默认True)
- sort_order: Integer (排序权重，默认0)
- created_at: DateTime (创建时间)
- updated_at: DateTime (最后修改时间，自动更新)

- 关系：
  - images: 与素材图片的一对多关系，级联删除，按sort_order排序
  - material_type: 关联到分类
```

---

### 3.4 MaterialImage（素材图片模型）

**文件位置**：`app/models/material_image.py`

**字段说明**：
```python
- id: Integer (主键)
- material_id: Integer (素材ID，外键，非空)
- image_url: String(500) (图片URL或路径，非空)
- sort_order: Integer (排序，默认0)
- is_cover: Boolean (是否封面图，默认False)
- created_at: DateTime (创建时间)

- 关系：
  - material: 关联到素材
```

---

### 3.5 RegisterSecret（注册卡密模型）

**文件位置**：`app/models/register_secret.py`

**字段说明**：
```python
- id: Integer (主键)
- secret: String(100) (卡密，唯一，索引，非空)
- is_used: Boolean (是否已使用，默认False)
- user_id: Integer (用户ID，外键，可空)
- created_at: DateTime (创建时间)
- used_at: DateTime (使用时间，可空)
- duration_type: String(20) (卡密类型：1min/1day/1month/1year/permanent，默认permanent)
- expires_at: DateTime (过期时间，可空)

- 关系：
  - user: 关联到用户
```

---

## 四、路由模块详解

### 4.1 应用配置（app/__init__.py）

**核心功能**：
- 工厂模式创建 Flask 应用
- 初始化数据库（SQLAlchemy）
- 初始化登录管理器（Flask-Login）
- 注册三个 Blueprint：
  - `main_bp`: 主路由（首页、个人中心、素材详情）
  - `auth_bp`: 认证路由（登录、注册、登出），前缀 `/auth`
  - `admin_bp`: 管理后台路由，前缀 `/admin`

**配置项**：
- `SECRET_KEY`: 会话密钥
- `SQLALCHEMY_DATABASE_URI`: 数据库连接地址（SQLite）
- `SQLALCHEMY_TRACK_MODIFICATIONS`: False（关闭修改跟踪）
- `WTF_CSRF_ENABLED`: False（临时禁用CSRF，方便开发）

---

### 4.2 主路由（app/routes/main/routes.py）

**路由列表**：

| 路由 | 方法 | 功能 | 登录要求 |
|------|------|------|---------|
| `/` | GET | 首页（轮播图 + 素材列表） | ✅ |
| `/profile` | GET | 个人中心 | ✅ |
| `/profile/edit` | GET/POST | 个人资料编辑 | ✅ |
| `/material/<material_id>` | GET | 素材详情页（增加浏览量） | ✅ |
| `/api/renew-secret` | POST | 卡密续费API | ✅ |
| `/api/latest-materials` | GET | 分页获取最新素材API | ✅ |

**核心功能**：
- **首页**：显示热度最高的前5个素材轮播图，最新入库素材列表（无限滚动加载）
- **个人中心**：显示用户信息、卡密状态（永久/有效期内/已失效）
- **个人资料编辑**：头像上传、昵称修改、性别选择、出生日期设置、个性签名编辑
- **素材详情**：1:1图片轮播、信息展示、下载按钮
- **卡密续费**：用户使用新卡密时，自动释放旧的过期卡密
- **分页API**：支持搜索、排序（最新/浏览/收藏/下载）

---

### 4.3 认证路由（app/routes/auth/routes.py）

**路由列表**：

| 路由 | 方法 | 功能 | 登录要求 |
|------|------|------|---------|
| `/auth/login` | GET/POST | 登录页面 | ❌ |
| `/auth/register` | GET/POST | 注册页面（需要卡密） | ❌ |
| `/auth/logout` | GET | 退出登录 | ✅ |

**核心功能**：
- **登录**：支持用户名或邮箱登录，记住我功能
- **注册**：需要卡密验证，注册时标记卡密已使用，计算过期时间
- **登出**：清除用户会话

---

### 4.4 管理后台路由（app/routes/admin/routes.py）

**主要功能**：
- **数据统计**：总素材数、未使用卡密数、用户总数、最新素材、最新卡密
- **素材管理**：
  - 素材列表（无限滚动、分类筛选、搜索）
  - 添加素材（标题、文案、分类、封面图、细节图）
  - 编辑素材（支持删除/新增细节图）
  - 删除素材（级联删除图片记录和文件）
- **分类管理**：AJAX增删改查，无需页面跳转
- **卡密管理**：
  - 卡密生成（选择时长、数量）
  - 卡密列表（状态筛选、搜索）
  - 一键删除已释放卡密
  - 手动释放未到期卡密
  - 复制卡密功能
- **用户管理**：
  - 用户列表（搜索）
  - 设置/取消管理员
  - 删除用户（级联删除关联卡密）

---

## 五、核心功能实现逻辑

### 5.1 卡密系统

#### 5.1.1 卡密生成
- **卡密格式**：`sk-` + 18位随机数字+英文大小写
- **时长类型**：
  - `1min`: 1分钟（测试用）
  - `1day`: 1天（日卡）
  - `1month`: 30天（月卡）
  - `1year`: 365天（年卡）
  - `permanent`: 永久
- **过期时间**：用户使用时才开始计算，而非生成时

#### 5.1.2 卡密续费逻辑
1. 用户在个人中心点击卡密，打开详情弹窗
2. 过期卡密显示续费表单
3. 用户输入新卡密，调用 `/api/renew-secret` API
4. 系统验证新卡密有效性
5. 释放用户旧的过期卡密（解除与用户关联，保留历史记录）
6. 标记新卡密为已使用，计算过期时间
7. 返回成功信息

#### 5.1.3 卡密状态显示
- **永久会员**：显示 "♾️ 永久会员"，黄色高亮
- **有效期内**：显示 "至 YYYY-MM-DD"，绿色显示
- **已失效**：显示 "已失效，请联系管理购买"，红色显示

---

### 5.2 素材详情页轮播图

**实现特点**：
- **1:1比例**：图片保持正方形展示
- **触摸滑动**：支持手势滑动切换
- **自动播放**：4秒自动切换
- **无限循环**：双向无感循环（左右无限滑动）
- **轮播指示器**：底部显示当前位置

**技术实现**：
- 克隆首尾图片实现无限循环
- 使用 `touchstart`、`touchmove`、`touchend` 事件处理触摸滑动
- 使用 `transform: translateX()` 实现平滑过渡

---

### 5.3 无限滚动加载

**实现逻辑**：
1. 监听页面滚动事件
2. 检查是否滚动到底部
3. 如果有更多数据，调用API获取下一页
4. 追加渲染新数据到列表
5. 更新是否有更多数据标志

**支持功能**：
- 分页获取
- 搜索（按标题）
- 排序（最新/浏览/收藏/下载）

---

## 六、页面路由汇总

### 前台页面
| 页面 | 地址 | 描述 |
|------|------|------|
| 首页 | `/` | 轮播图 + 素材列表 |
| 个人中心 | `/profile` | 用户信息 + 卡密状态 |
| 个人资料编辑 | `/profile/edit` | 编辑个人信息 |
| 素材详情 | `/material/<id>` | 查看素材详情 |

### 认证页面
| 页面 | 地址 | 描述 |
|------|------|------|
| 登录 | `/auth/login` | 用户登录 |
| 注册 | `/auth/register` | 用户注册（需卡密） |
| 登出 | `/auth/logout` | 退出登录 |

### 管理后台
| 页面 | 地址 | 描述 |
|------|------|------|
| 管理后台首页 | `/admin/` | 数据统计 |
| 素材库管理 | `/admin/materials` | 素材列表管理 |
| 添加素材 | `/admin/materials/add` | 新增素材 |
| 编辑素材 | `/admin/materials/edit/<id>` | 编辑素材 |
| 分类管理 | `/admin/material-types` | 素材分类管理 |
| 卡密管理 | `/admin/secrets` | 卡密列表管理 |
| 用户管理 | `/admin/users` | 用户列表管理 |

---

## 七、数据库迁移脚本

### 7.1 卡密表迁移（scripts/migrate_secrets_table.py）
**功能**：
- 添加 `duration_type` 列
- 添加 `expires_at` 列
- 更新现有数据默认值

### 7.2 用户表迁移（scripts/migrate_user_table.py）
**功能**：
- 添加 `avatar` 列
- 添加 `bio` 列
- 添加 `gender` 列
- 添加 `birthday` 列

### 7.3 素材统计更新（scripts/update_material_stats.py）
**功能**：（临时测试脚本）
- 为所有素材生成随机的浏览、收藏、下载数据（1-10000）

---

## 八、使用说明

### 8.1 运行应用
```powershell
# 激活虚拟环境
.\venv\Scripts\activate

# 运行应用
python run.py
```

访问地址：`http://localhost:5000`

### 8.2 数据库迁移
如果需要迁移数据库表：
```powershell
python scripts/migrate_user_table.py
python scripts/migrate_secrets_table.py
```

---

## 九、已完成功能清单

- ✅ 用户注册（卡密验证）
- ✅ 用户登录（支持用户名/邮箱）
- ✅ 用户退出登录
- ✅ 个人中心页面（显示用户信息、角色标签）
- ✅ 个人资料编辑（头像、昵称、邮箱、性别、生日、签名）
- ✅ 邮箱只读保护
- ✅ 卡密管理功能（生成、列表、搜索、释放、删除）
- ✅ 用户管理功能（列表、搜索、设置/取消管理员、删除）
- ✅ 管理后台数据统计实时渲染
- ✅ 素材分类管理（AJAX增删改查）
- ✅ 素材添加功能（标题、文案、分类、图片）
- ✅ 素材编辑功能
- ✅ 素材删除功能
- ✅ 素材列表无限滚动加载
- ✅ 素材分类筛选
- ✅ 素材搜索功能
- ✅ 首页轮播图（真实数据，热度排行）
- ✅ 素材详情页（1:1轮播图、信息展示、下载按钮）
- ✅ 卡密详情弹窗与续费功能
- ✅ 旧卡密释放逻辑
- ✅ 用户级联删除

---

## 十、项目特点

1. **模块化设计**：采用 Blueprint + 工厂模式，代码结构清晰
2. **移动端优先**：使用 Tailwind CSS 实现响应式布局，完美适配移动端
3. **数据库优化**：合理使用索引，查询效率高
4. **用户体验**：无限滚动、AJAX操作、平滑动画
5. **安全性**：密码加密、CSRF保护、登录验证
6. **可扩展性**：预留了多个字段和接口，方便后续功能扩展
