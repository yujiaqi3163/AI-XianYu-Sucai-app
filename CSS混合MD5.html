<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIç´ æäºŒåˆ› + MD5é‡å¡‘å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --con: 1.1; --bri: 1.0; --sat: 1.2;
            --grad: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);
            --blend: overlay; --op: 0.3;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 30px; }
        
        .workspace { max-width: 800px; width: 100%; }

        /* æ¸²æŸ“å®¹å™¨ */
        #render-target {
            position: relative;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            line-height: 0;
        }

        #sourceImg { width: 100%; height: auto; filter: contrast(var(--con)) brightness(var(--bri)) saturate(var(--sat)); }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            mix-blend-mode: var(--blend);
            background: var(--grad);
            opacity: var(--op);
            pointer-events: none;
        }

        /* æ§åˆ¶åŒº */
        .controls {
            margin-top: 25px; background: white; padding: 20px; border-radius: 15px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
        }

        button, .file-btn {
            padding: 12px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; text-align: center; transition: 0.2s; font-size: 14px;
        }
        .btn-upload { background: #e2e8f0; color: #475569; position: relative; }
        .btn-rand { background: #6366f1; color: white; }
        .btn-save { background: #10b981; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        #fileInput { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        .status-bar { margin-top: 15px; font-size: 12px; color: #94a3b8; }
    </style>
</head>
<body>

    <h2>ğŸš€ äºŒåˆ› & MD5 è‡ªåŠ¨é‡å¡‘å™¨</h2>

    <div class="workspace">
        <div id="render-target">
            <img id="sourceImg" src="https://via.placeholder.com/800x400?text=Step+1:+Upload+Image" crossOrigin="anonymous">
            <div class="overlay" id="overlay"></div>
        </div>

        <div class="controls">
            <div class="file-btn btn-upload">
                1. å¯¼å…¥ç´ æ
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <button class="btn-rand" onclick="randomize()">2. éšæœºè§†è§‰æ•ˆæœ</button>
            <button class="btn-save" onclick="exportAndChangeMD5()">3. å¯¼å‡ºæ–°ç´ æ (æ–°MD5)</button>
        </div>
        <div class="status-bar" id="status">å‡†å¤‡å°±ç»ª</div>
    </div>

<script>
    const root = document.documentElement;
    const status = document.getElementById('status');

    // é…æ–¹åº“
    const recipes = [
        { g: 'linear-gradient(45deg, #ff9a9e, #fad0c4)', b: 'multiply' },
        { g: 'linear-gradient(120deg, #a1c4fd, #c2e9fb)', b: 'overlay' },
        { g: 'linear-gradient(to right, #43e97b, #38f9d7)', b: 'soft-light' },
        { g: 'linear-gradient(135deg, #667eea, #764ba2)', b: 'screen' }
    ];

    function randomize() {
        const r = recipes[Math.floor(Math.random() * recipes.length)];
        root.style.setProperty('--grad', r.g);
        root.style.setProperty('--blend', r.b);
        root.style.setProperty('--con', (Math.random() * 0.3 + 1.1).toFixed(2));
        root.style.setProperty('--op', (Math.random() * 0.2 + 0.2).toFixed(2));
        status.innerText = "è§†è§‰æ•ˆæœå·²æ›´æ–°";
    }

    async function exportAndChangeMD5() {
        status.innerText = "æ­£åœ¨æ•è·å¹¶ä¿®æ”¹ MD5...";
        
        // 1. ä½¿ç”¨ html2canvas å°†å½“å‰è§†è§‰æ•ˆæœæ¸²æŸ“ä¸º Canvas
        const canvas = await html2canvas(document.getElementById('render-target'), {
            useCORS: true,
            scale: 2 // ä¿æŒé«˜æ¸…æ™°åº¦
        });

        // 2. è½¬åŒ–ä¸º Blob æ•°æ®
        canvas.toBlob(async (blob) => {
            const arrayBuffer = await blob.arrayBuffer();
            
            // 3. ä¿®æ”¹ MD5 çš„æ ¸å¿ƒï¼šæ³¨å…¥éšæœºå­—èŠ‚
            // åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€ä¸ªåŒ…å«å½“å‰æ—¶é—´æˆ³çš„éšæœº Uint8 æ•°ç»„
            const padding = new TextEncoder().encode("\n#MD5_SALT_" + Date.now() + "_" + Math.random());
            const newFileContent = new Uint8Array(arrayBuffer.byteLength + padding.byteLength);
            
            newFileContent.set(new Uint8Array(arrayBuffer), 0);
            newFileContent.set(padding, arrayBuffer.byteLength);

            // 4. è§¦å‘ä¸‹è½½
            const newBlob = new Blob([newFileContent], { type: 'image/png' });
            const url = URL.createObjectURL(newBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `remix_${Date.now()}.png`;
            a.click();
            
            status.innerText = "å®Œæˆï¼å·²ä¿å­˜ä¸º MD5 å”¯ä¸€çš„æ–°æ–‡ä»¶ã€‚";
        }, 'image/png');
    }

    // å¤„ç†ä¸Šä¼ 
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => { document.getElementById('sourceImg').src = ev.target.result; };
            reader.readAsDataURL(file);
        }
    };
</script>
</body>
</html>